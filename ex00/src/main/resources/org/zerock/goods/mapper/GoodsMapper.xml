<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
  <mapper namespace="org.zerock.goods.mapper.GoodsMapper">

  <select id="list" parameterType="org.zerock.goods.vo.GoodsSearchVO" resultType="org.zerock.goods.vo.GoodsVO">
    SELECT goods_no, goods_name, price, discount_rate, sale_price, image_name, content
    FROM (
        SELECT g.goods_no, g.goods_name, p.price, p.discount_rate,
               p.sale_price, g.image_name, g.content,
               ROW_NUMBER() OVER (ORDER BY g.goods_no) AS rnum
        FROM goods g
        JOIN goods_price p ON g.goods_no = p.goods_no
        <where>
            <if test="goodsSearchVO.cate_code1 != null and goodsSearchVO.cate_code1 != 0">
                AND g.cate_code1 = #{goodsSearchVO.cate_code1}
            </if>
        </where>
    )
    WHERE rnum BETWEEN #{pageObject.startRow} AND #{pageObject.endRow}
</select>




  	
  	<select id="getTotalRow" resultType="Long">
    SELECT count(*)
    FROM goods g
    JOIN goods_price p ON g.goods_no = p.goods_no
	</select>

  	<sql id="search">
    <trim prefixOverrides="and">
        <!-- 제품명 조건 -->
        <if test="goodsSearchVO.goods_name != null and goodsSearchVO.goods_name != ''">
            AND goods_name LIKE '%' || #{goodsSearchVO.goods_name} || '%'
        </if>

        <!-- 최소 가격 조건 -->
        <if test="goodsSearchVO.min_price != null and goodsSearchVO.min_price != 0">
            <![CDATA[
                AND sale_price >= #{goodsSearchVO.min_price}
            ]]>
        </if>

        <!-- 최대 가격 조건 -->
        <if test="goodsSearchVO.max_price != null and goodsSearchVO.max_price != 0">
            <![CDATA[
                AND sale_price <= #{goodsSearchVO.max_price}
            ]]>
        </if>
    </trim>
</sql>

  	
  	<select id="getCategory" resultType="org.zerock.category.vo.CategoryVO">
	    SELECT cate_code1, cate_name 
	    FROM category 
	    WHERE 1=1
	    <if test="cate_code1 != null and cate_code1 > 0">
	        AND cate_code1 = #{cate_code1}
	    </if>
	</select>

  	
  	<select id="view" resultType="org.zerock.goods.vo.GoodsVO">
    SELECT
        g.goods_no, g.goods_name, g.goods_code, g.cate_code1, c.cate_name, g.image_name, g.content, g.company,
        p.price, p.discount_rate, p.sale_price, p.delivary_charge, p.goods_price_no
    FROM goods g
    JOIN goods_price p ON g.goods_no = p.goods_no
    JOIN category c ON g.cate_code1 = c.cate_code1
    WHERE g.goods_no = #{goods_no}
</select>


  	
  	<select id="imageList" resultType="org.zerock.goods.vo.GoodsImageVO">
	    SELECT goods_img_no, goods_img_name, goods_no 
	    FROM goods_image 
	    WHERE goods_no = #{goods_no}
	</select>

  	
  	<insert id="write">
    <selectKey keyProperty="goods_no" resultType="Long" order="BEFORE">
        select goods_seq.nextval from dual
    </selectKey>
    insert into goods(goods_no, goods_name, cate_code1, image_name, content, company, goods_code)
    values(#{goods_no}, #{goods_name}, #{cate_code1}, #{image_name}, #{content}, #{company}, #{goods_code,jdbcType=VARCHAR})
</insert>


  	<insert id="writePrice" parameterType="org.zerock.goods.vo.GoodsVO">
    <selectKey keyProperty="goods_price_no" resultType="Long" order="BEFORE">
        SELECT goods_price_seq.NEXTVAL FROM dual
    </selectKey>
    INSERT INTO goods_price (goods_price_no, price, discount_rate, sale_price, delivary_charge, goods_no)
    VALUES (
        #{goods_price_no},
        #{price, jdbcType=INTEGER}, 
        #{discount_rate, jdbcType=INTEGER},
        #{sale_price, jdbcType=INTEGER},
        #{delivary_charge, jdbcType=VARCHAR}, 
        #{goods_no, jdbcType=INTEGER} 
    )
</insert>


  	<insert id="writeImage">
    insert into goods_image(goods_img_no, goods_img_name, goods_no)
    values(goods_image_seq.nextval, #{goods_img_name}, #{goods_no})
</insert>

  	
  	<update id="update" parameterType="org.zerock.goods.vo.GoodsVO">
    UPDATE goods
    SET goods_name = #{goods_name},
        cate_code1 = #{cate_code1},
		image_name = #{image_name, jdbcType=VARCHAR},  
        content = #{content},
        company = #{company},
        goods_code = #{goods_code,jdbcType=VARCHAR}
    WHERE goods_no = #{goods_no, jdbcType=BIGINT}
</update>


<update id="updatePrice" parameterType="org.zerock.goods.vo.GoodsVO">
    UPDATE goods_price
    SET price = #{price, jdbcType=INTEGER},
        discount_rate = #{discount_rate, jdbcType=INTEGER},
        sale_price = #{sale_price, jdbcType=INTEGER},
        delivary_charge = #{delivary_charge, jdbcType=VARCHAR}
    WHERE goods_price_no = #{goods_price_no, jdbcType=BIGINT}
</update>
<!-- <update id="updateImage" parameterType="org.zerock.goods.vo.GoodsImageVO"> -->
<!--     UPDATE goods -->
<!--     SET image_name = #{fileName} -->
<!--     WHERE goods_no = #{no} -->
<!-- </update> -->




  </mapper>
  
  
  
  
  
  